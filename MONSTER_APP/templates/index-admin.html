{% extends "partial/body.html" %}
{% load static %}
{% block contenido %}

{% if user.is_authenticated %}

<!-- Mensaje de bienvenida animado -->
<section class="content bg-" data-bs-theme="dark" style="padding: 10px 20px;">
    <div class="container-fluid">
        <div class="pagetitle text-center" >
            <h2 id="saludo"></h2>
            <p id="bienvenida"></p>
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const nombre = "{{ user_first_name|escapejs }}";
                const texto1 = `Hola, ${nombre}`;
                const texto2 = `Bienvenido (a) al sistema analítico, `;
                const etiquetaFinal = `<span><strong class="text-secondary">Monster APP</strong>.</span>`;
                let i = 0, j = 0;
                const h2 = document.getElementById("saludo");
                const p = document.getElementById("bienvenida");

                function escribirTitulo() {
                    if (i < texto1.length) {
                        h2.innerHTML += texto1.charAt(i);
                        i++;
                        setTimeout(escribirTitulo, 40);
                    } else {
                        setTimeout(escribirParrafo, 30);
                    }
                }

                function escribirParrafo() {
                    if (j < texto2.length) {
                        p.innerHTML += texto2.charAt(j);
                        j++;
                        setTimeout(escribirParrafo, 30);
                    } else {
                        p.innerHTML += etiquetaFinal;
                    }
                }
                escribirTitulo();
            });
        </script>
    </div>
</section>

<!-- Dashboard completo -->
<section class="content bg-" data-bs-theme="dark">
    <div class="container-fluid">

        <!-- Cards superiores -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-gradient-info">
                    <div class="inner">
                        <h3>{{ registro_total_protocolo_metodos }}</h3>
                        <p>Protocolo de Métodos</p>
                    </div>
                    <div class="icon"><i class="ion ion-bag"></i></div>
                    <a href="{% url 'protocolo_metodos' %}" class="small-box-footer">Más información <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-gradient-success text-white">
                    <div class="inner">
                        <h3>{{ registro_total_protocolo_proceso }}</h3>
                        <p>Protocolos de Proceso</p>
                    </div>
                    <div class="icon"><i class="ion ion-stats-bars"></i></div>
                    <a href="{% url 'protocolo_proceso' %}" class="small-box-footer">Más información <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-gradient-warning text-white">
                    <div class="inner">
                        <h3>{{ registro_desarrollos }}</h3>
                        <p>Desarrollos</p>
                    </div>
                    <div class="icon"><i class="ion ion-person-add"></i></div>
                    <a href="#" class="small-box-footer">Más información <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-gradient-danger text-white">
                    <div class="inner">
                        <h3>{{ registro_estabilidades }}</h3>
                        <p>Estabilidades</p>
                    </div>
                    <div class="icon"><i class="ion ion-pie-graph"></i></div>
                    <a href="#" class="small-box-footer">Más información <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
            <section class="col-lg-6 connectedSortable">
                <div class="card">
                    <div class="card-header bg-gradient-info">
                        <h3 class="card-title"><i class="fas fa-chart-pie mr-1"></i>Protocolos Finalizados</h3>
                    </div>
                    <div class="card-body" id="grafico_metodos_finalizados"></div>
                </div>
            </section>

            <section class="col-lg-6 connectedSortable">
                <div class="card bg-gradient-white">
                    <div class="card-header bg-gradient-info">
                        <h3 class="card-title"><i class="fas fa-chart-pie mr-1"></i>Estado de Protocolos</h3>
                    </div>
                    <div class="card-body" id="grafico_motivos_metodos"></div>
                </div>
            </section>
        </div>

        <div class="row">
            <section class="col-lg-6 connectedSortable">
                <div class="card">
                    <div class="card-header bg-gradient-info">
                        <h3 class="card-title"><i class="fas fa-chart-pie mr-1"></i>Procesos Finalizados</h3>
                    </div>
                    <div class="card-body" id="grafico_proceso_finalizados"></div>
                </div>
            </section>

            <section class="col-lg-6 connectedSortable">
                <div class="card bg-gradient-white">
                    <div class="card-header bg-gradient-info">
                        <h3 class="card-title"><i class="fas fa-chart-pie mr-1"></i>Motivos de Procesos</h3>
                    </div>
                    <div class="card-body" id="grafico_motivos_proceso"></div>
                </div>
            </section>
        </div>
    </div>
</section>

<!-- Scripts Highcharts -->
<script src="{% static 'js/highcharts/12.3.0/highcharts.js' %}"></script>
<script src="{% static 'js/highcharts/12.3.0/modules/data.js' %}"></script>
<script src="{% static 'js/highcharts/12.3.0/modules/exporting.js' %}"></script>
<script src="{% static 'js/highcharts/12.3.0/modules/accessibility.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const añoActual = "{{ año_actual }}";
    const iniciales = ['metodos_finalizados', 'motivos_metodos', 'proceso_finalizados', 'motivos_proceso'];

    iniciales.forEach(grafico => cargarGrafico(grafico, añoActual));

    function cargarGrafico(grafico, año) {
        let url = "", containerId = "";
        switch (grafico) {
            case 'metodos_finalizados':
                url = `/api/chart/finalizados/metodos/${año}/`; containerId = 'grafico_metodos_finalizados'; break;
            case 'motivos_metodos':
                url = `/api/chart/motivos/metodos/${año}/`; containerId = 'grafico_motivos_metodos'; break;
            case 'proceso_finalizados':
                url = `/api/chart/finalizados/proceso/${año}/`; containerId = 'grafico_proceso_finalizados'; break;
            case 'motivos_proceso':
                url = `/api/chart/motivos/proceso/${año}/`; containerId = 'grafico_motivos_proceso'; break;
        }
        fetch(url).then(res=>res.json()).then(data=>{
            let options = (grafico.includes('finalizados')) ? {
                chart: { type: 'column' },
                title: { text: null },
                xAxis: { categories: data.categories },
                series: [{ name: 'Finalizado', data: data.data }]
            } : data;
            Highcharts.chart(containerId, options);
        });
    }
});
</script>

{% else %}
<h2>No has iniciado sesión</h2>
{% endif %}

{% endblock contenido %}